<!--
    Archivo: EditEmpresa.html
    Descripción: Página para editar los datos de una empresa en SenaLink.
    Incluye formulario, validaciones y carga de datos vía fetch.
-->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>SenaLink - Editar Empresa</title>
    <!-- Fuentes de iconos de Google Material Symbols -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=menu"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=account_circle"
    />
    <!-- Hojas de estilo personalizadas -->
    <!-- <link rel="stylesheet" href="../css/crud.css"> -->
    <link rel="stylesheet" href="../css/alert.css" />
    <link rel="stylesheet" href="../css/components/gov.css" />
    <link rel="stylesheet" href="../css/components/buttons.css" />
    <link rel="stylesheet" href="../css/components/footer.css" />
    <link rel="stylesheet" href="../css/layouts/Form_layout.css" />
    <link rel="stylesheet" href="../css/base.css" />
    <link rel="stylesheet" href="../css/readonly-fields.css" />
    <!-- Favicon de la pestaña -->
    <link rel="shortcut icon " href="../img/Favicon1.png" />
    <!-- corresponde al favicon en la pestaña -->
  </head>
  <body>
    <!-- Encabezado de gobierno -->
    <header class="gov" id="inicio">
      <div class="gov__container">
        <a href="https://www.gov.co/" target="_blank">
          <img
            loading="lazy"
            src="../img/gov-logo.svg"
            alt="Logo de la pagina gov.co"
            class="gov__img"
          />
        </a>
      </div>
    </header>
    <!-- Contenedor principal -->
    <div class="container">
      <main class="container__crud">
        <!-- Logo de la aplicación -->
        <img
          alt="SenaLink Logo"
          src="../img/logo-proyecto1.png"
          class="logo__senalink"
        />
        <!-- FORMULARIO DE REGISTRO/EDICIÓN DE EMPRESA -->

        <form
          action="../controllers/EmpresaController.php"
          method="POST"
          id="empresaForm"
          class="form-layout validated-form"
        >
          <!-- Campo oculto para el ID de la empresa -->
          <input type="hidden" name="id" id="empresa_id" value="" />
          <input type="hidden" name="accion" value="actualizarEmpresa" />

          <div class="form-group">
            <label for="nit">Número NIT</label>
            <input
              id="nit"
              class="input-field readonly-field"
              name="nit"
              type="text"
              placeholder="Número NIT"
              required
              readonly
            />
          </div>

          <div class="form-group">
            <label for="representante_legal">Representante legal</label>
            <input
              id="representante_legal"
              class="input-field"
              name="representante_legal"
              type="text"
              placeholder="Representante legal"
              required
            />
          </div>

          <div class="form-group">
            <label for="razon_social">Razón social</label>
            <input
              id="razon_social"
              class="input-field readonly-field"
              name="razon_social"
              type="text"
              placeholder="Razón social"
              required
              readonly
            />
          </div>

          <div class="form-group">
            <label for="telefono">Número telefónico</label>
            <input
              id="telefono"
              class="input-field"
              name="telefono"
              type="text"
              placeholder="Número telefónico"
              required
            />
          </div>

          <div class="form-group">
            <label for="correo">Correo electrónico</label>
            <input
              id="correo"
              class="input-field"
              name="correo"
              type="email"
              placeholder="Correo electrónico"
              required
            />
          </div>

          <div class="form-group">
            <label for="direccion">Dirección</label>
            <input
              id="direccion"
              class="input-field"
              name="direccion"
              type="text"
              placeholder="Dirección"
              required
            />
          </div>

          <!-- Nuevo campo Barrio -->
          <div class="form-group">
            <label for="barrio">Barrio</label>
            <input
              id="barrio"
              class="input-field"
              name="barrio"
              type="text"
              placeholder="Barrio"
              required
            />
          </div>

          <div class="form-group">
            <label for="departamento">Departamento(s)</label>
            <select
              id="departamento"
              name="departamento"
              class="select_container"
              required
            >
              <option value="Amazonas">Amazonas</option>
              <option value="Antioquia">Antioquia</option>
              <option value="Arauca">Arauca</option>
              <option value="Atlántico">Atlántico</option>
              <option value="Bogotá D.C.">Bogotá D.C.</option>
              <option value="Bolívar">Bolívar</option>
              <option value="Boyacá">Boyacá</option>
              <option value="Caldas">Caldas</option>
              <option value="Caquetá">Caquetá</option>
              <option value="Casanare">Casanare</option>
              <option value="Cauca">Cauca</option>
              <option value="Cesar">Cesar</option>
              <option value="Chocó">Chocó</option>
              <option value="Córdoba">Córdoba</option>
              <option value="Cundinamarca">Cundinamarca</option>
              <option value="Guainía">Guainía</option>
              <option value="Guaviare">Guaviare</option>
              <option value="Huila">Huila</option>
              <option value="La Guajira">La Guajira</option>
              <option value="Magdalena">Magdalena</option>
              <option value="Meta">Meta</option>
              <option value="Nariño">Nariño</option>
              <option value="Norte de Santander">Norte de Santander</option>
              <option value="Putumayo">Putumayo</option>
              <option value="Quindío">Quindío</option>
              <option value="Risaralda">Risaralda</option>
              <option value="San Andrés y Providencia">
                San Andrés y Providencia
              </option>
              <option value="Santander">Santander</option>
              <option value="Sucre">Sucre</option>
              <option value="Tolima">Tolima</option>
              <option value="Valle del Cauca">Valle del Cauca</option>
              <option value="Vaupés">Vaupés</option>
              <option value="Vichada">Vichada</option>
            </select>
          </div>
          <div class="form-group">
            <label for="ciudad">Ciudad(es)</label>
            <select
              id="ciudad"
              name="ciudad"
              class="select_container"
              required
            >
              <!-- Opciones se llenan dinámicamente -->
            </select>
          </div>
          <div class="form-group">
            <label for="tipo_empresa">Sector Económico</label>
            <input
              type="hidden"
              name="tipo_empresa"
              id="tipo_empresa"
              value=""
            />
            <input
              type="text"
              id="tipo_empresa_display"
              class="input-field readonly-field"
              value=""
              readonly
              tabindex="-1"
            />
          </div>

          <div class="btn__container">
            <button type="submit" class="btn">Guardar</button>
            <button type="button" onclick="goBack()" class="btn">Volver</button>
          </div>
        </form>
      </main>
    </div>
    <!-- Scripts de funcionalidad -->
    <script src="../js/backbutton.js"></script>
    <!-- Controla el botón de volver -->
    <script src="../js/alert.js"></script>
    <!-- Muestra alertas personalizadas -->

    <script>
      // Guarda los valores originales del formulario para detectar cambios
      let originalValues = {};

      // Obtiene los valores actuales del formulario
      function getFormValues() {
        return {
          nit: document.getElementById('nit').value,
          representante_legal: document.getElementById('representante_legal')
            .value,
          razon_social: document.getElementById('razon_social').value,
          telefono: document.getElementById('telefono').value,
          correo: document.getElementById('correo').value,
          direccion: document.getElementById('direccion').value,
          barrio: document.getElementById('barrio').value, // nuevo
          ciudad: document.getElementById('ciudad').value, // nuevo
          departamento: document.getElementById('departamento').value, // nuevo
          tipo_empresa: document.getElementById('tipo_empresa').value,
        };
      }

      // Compara si los valores actuales difieren de los originales
      function valuesChanged(current, original) {
        return Object.keys(original).some(
          (key) => current[key] != original[key]
        );
      }

      document.addEventListener('DOMContentLoaded', function () {
        // Manejo del envío del formulario usando fetch y validaciones
        const form = document.getElementById('empresaForm');
        form.addEventListener('submit', function (event) {
          const currentValues = getFormValues();
          if (!valuesChanged(currentValues, originalValues)) {
            // No hacer nada si no hay cambios
            event.preventDefault();
            return;
          }
          // Validación: la razón social debe incluir tipo societario
          const razonSocial = document
            .getElementById('razon_social')
            .value.trim();
          if (!/(S\.?A\.?|S\.?A\.?S\.?|LTDA)/i.test(razonSocial)) {
            event.preventDefault();
            showAlert(
              'La razón social debe incluir el tipo societario: S.A, S.A.S o LTDA.',
              'error'
            );
            return;
          }
          event.preventDefault();
          const formData = new FormData(form);
          fetch(form.action, {
            method: 'POST',
            body: formData,
          })
            .then((response) => {
              // Si la respuesta es JSON, procesar como tal
              const contentType = response.headers.get('content-type');
              if (
                contentType &&
                contentType.indexOf('application/json') !== -1
              ) {
                return response.json();
              } else {
                return response.text();
              }
            })
            .then((data) => {
              // Manejo de la respuesta del servidor
              if (typeof data === 'object' && data !== null && data.success) {
                showAlert('Datos actualizados correctamente', 'success');
                setTimeout(() => {
                  window.location.href = 'viewuser.html';
                }, 2000);
              } else if (
                typeof data === 'string' &&
                data.includes('actualizado')
              ) {
                showAlert('Datos actualizados correctamente', 'success');
                setTimeout(() => {
                  window.location.href = 'viewuser.html';
                }, 2000);
              } else if (
                typeof data === 'object' &&
                data !== null &&
                data.errors
              ) {
                // Mostrar todos los mensajes de error concatenados
                const mensajes = data.errors.join('<br>');
                showAlert(mensajes, 'error');
              } else if (
                typeof data === 'object' &&
                data !== null &&
                data.error
              ) {
                showAlert(data.error, 'error');
              } else {
                showAlert('Error al actualizar la empresa', 'error');
              }
            })
            .catch(() => {
              showAlert('Error en la comunicación con el servidor', 'error');
            });
        });

        // Obtiene el ID de la empresa desde la URL y carga los datos
        const empresaId = new URLSearchParams(window.location.search).get('id');
        if (empresaId) {
          fetch(
            `../controllers/EmpresaController.php?action=detalleEmpresa&id=${empresaId}`
          )
            .then((response) => response.json())
            .then((data) => {
              if (!data.error) {
                document.getElementById('empresa_id').value = empresaId;
                document.getElementById('nit').value = data.nit || '';
                document.getElementById('representante_legal').value =
                  data.representante_legal || '';
                document.getElementById('razon_social').value =
                  data.razon_social || '';
                document.getElementById('telefono').value = data.telefono || '';
                document.getElementById('correo').value = data.correo || '';
                document.getElementById('direccion').value =
                  data.direccion || '';
                document.getElementById('barrio').value = data.barrio || ''; // nuevo
                document.getElementById('ciudad').value = data.ciudad || ''; // nuevo
                document.getElementById('departamento').value =
                  data.departamento || ''; // nuevo
                document.getElementById('tipo_empresa').value =
                  data.tipo_empresa || '';
                document.getElementById('tipo_empresa_display').value =
                  data.tipo_empresa || '';
                originalValues = getFormValues();
              } else {
                alert('Error al cargar los datos de la empresa.');
              }
            })
            .catch((error) => {
              console.error('Error al cargar los datos de la empresa:', error);
              alert('Error al cargar los datos de la empresa.');
            });
        } else {
          alert('No se recibió el ID de la empresa.');
        }
      });
      document.addEventListener('DOMContentLoaded', function () {
        // Mapa de departamentos y sus ciudades (ejemplo simplificado)
        const departamentosCiudades = {
          Amazonas: ['Leticia', 'Puerto Nariño'],
          Antioquia: [
            'Medellín',
            'Bello',
            'Itagüí',
            'Envigado',
            'Rionegro',
            'Turbo',
            'Apartadó',
            'La Ceja',
            'Sabaneta',
            'Copacabana',
            'Girardota',
            'Marinilla',
          ],
          Arauca: ['Arauca', 'Arauquita', 'Saravena', 'Tame', 'Fortul'],
          Atlántico: [
            'Barranquilla',
            'Soledad',
            'Malambo',
            'Puerto Colombia',
            'Sabanalarga',
          ],
          'Bogotá D.C.': ['Bogotá'],
          Bolívar: [
            'Cartagena',
            'Magangué',
            'Turbaco',
            'Arjona',
            'San Juan Nepomuceno',
            'El Carmen de Bolívar',
          ],
          Boyacá: [
            'Tunja',
            'Duitama',
            'Sogamoso',
            'Chiquinquirá',
            'Paipa',
            'Puerto Boyacá',
          ],
          Caldas: ['Manizales', 'Villamaría', 'Chinchiná', 'La Dorada'],
          Caquetá: [
            'Florencia',
            'San Vicente del Caguán',
            'Puerto Rico',
            'El Doncello',
          ],
          Casanare: [
            'Yopal',
            'Aguazul',
            'Villanueva',
            'Monterrey',
            'Tauramena',
          ],
          Cauca: [
            'Popayán',
            'Santander de Quilichao',
            'Puerto Tejada',
            'Patía',
            'Miranda',
          ],
          Cesar: [
            'Valledupar',
            'Aguachica',
            'Bosconia',
            'Curumaní',
            'La Jagua de Ibirico',
          ],
          Chocó: ['Quibdó', 'Istmina', 'Condoto', 'Bahía Solano', 'Acandí'],
          Córdoba: [
            'Montería',
            'Cereté',
            'Lorica',
            'Sahagún',
            'Tierralta',
            'Planeta Rica',
          ],
          Cundinamarca: [
            'Soacha',
            'Zipaquirá',
            'Girardot',
            'Facatativá',
            'Fusagasugá',
            'Chía',
            'Mosquera',
            'Cajicá',
            'Funza',
            'Madrid',
          ],
          Guainía: ['Inírida'],
          Guaviare: ['San José del Guaviare'],
          Huila: ['Neiva', 'Pitalito', 'Garzón', 'La Plata'],
          'La Guajira': [
            'Riohacha',
            'Maicao',
            'Uribia',
            'Fonseca',
            'San Juan del Cesar',
          ],
          Magdalena: [
            'Santa Marta',
            'Ciénaga',
            'Fundación',
            'Plato',
            'Aracataca',
          ],
          Meta: [
            'Villavicencio',
            'Acacías',
            'Granada',
            'Puerto López',
            'Cumaral',
          ],
          Nariño: ['Pasto', 'Ipiales', 'Tumaco', 'Túquerres'],
          'Norte de Santander': [
            'Cúcuta',
            'Ocaña',
            'Pamplona',
            'Villa del Rosario',
            'Los Patios',
          ],
          Putumayo: ['Mocoa', 'Puerto Asís', 'Orito', 'Villagarzón'],
          Quindío: [
            'Armenia',
            'Calarcá',
            'La Tebaida',
            'Montenegro',
            'Quimbaya',
          ],
          Risaralda: [
            'Pereira',
            'Dosquebradas',
            'Santa Rosa de Cabal',
            'La Virginia',
          ],
          'San Andrés y Providencia': ['San Andrés', 'Providencia'],
          Santander: [
            'Bucaramanga',
            'Floridablanca',
            'Giron',
            'Piedecuesta',
            'Barrancabermeja',
            'Socorro',
            'San Gil',
          ],
          Sucre: ['Sincelejo', 'Corozal', 'Sampués', 'Tolú', 'San Marcos'],
          Tolima: ['Ibagué', 'Espinal', 'Melgar', 'Honda', 'Mariquita'],
          'Valle del Cauca': [
            'Cali',
            'Palmira',
            'Buenaventura',
            'Tuluá',
            'Buga',
            'Cartago',
            'Jamundí',
            'Yumbo',
          ],
          Vaupés: ['Mitú'],
          Vichada: ['Puerto Carreño'],

          // Agrega más departamentos y ciudades según necesites
        };

        const departamentosSelect = document.getElementById('departamento');
        const ciudadesSelect = document.getElementById('ciudad');

        function actualizarCiudades() {
          // Obtener departamentos seleccionados
          const seleccionados = Array.from(
            departamentosSelect.selectedOptions
          ).map((opt) => opt.value);

          // Limpiar opciones actuales de ciudades
          ciudadesSelect.innerHTML = '';

          // Crear un Set para evitar ciudades duplicadas si hay varios departamentos seleccionados
          const ciudadesSet = new Set();

          // Agregar ciudades de los departamentos seleccionados
          seleccionados.forEach((depto) => {
            const ciudades = departamentosCiudades[depto] || [];
            ciudades.forEach((ciudad) => ciudadesSet.add(ciudad));
          });

          // Agregar opciones al select de ciudades
          ciudadesSet.forEach((ciudad) => {
            const option = document.createElement('option');
            option.value = ciudad;
            option.textContent = ciudad;
            ciudadesSelect.appendChild(option);
          });

          // Si no hay departamentos seleccionados, deshabilitar ciudades
          ciudadesSelect.disabled = seleccionados.length === 0;
        }

        // Inicializar ciudades deshabilitadas
        ciudadesSelect.disabled = true;

        // Escuchar cambios en departamentos
        departamentosSelect.addEventListener('change', actualizarCiudades);
      });
    </script>
  </body>
</html>
