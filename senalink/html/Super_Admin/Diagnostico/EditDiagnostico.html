<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>SenaLink - Editar Formulario</title>

    <!-- Iconos -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=menu" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=account_circle" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <!-- Estilos -->
    <link rel="stylesheet" href="../../../css/Inputs.css">
    <link rel="shortcut icon" href="../../../img/Favicon1.png">
    <link rel="stylesheet" href="../../../css/btn-guardar-pregunta.css">
</head>
<body>
    <header class="gov" id="inicio">
        <div class="gov__container">
            <a href="https://www.gov.co/" target="_blank">
                <img loading="lazy" src="../../../img/gov-logo.svg" alt="Logo de la pagina gov.co" class="gov__img">
            </a>
        </div>
    </header>

    <!-- Encabezado -->
    <header class="header__login">
        <div class="header__left">
        </div>

        <div class="header__center">
        </div>

        <div class="header__right">
        <img src="../../../icon/account_circle_24dp_FFFFFF_FILL0_wght400_GRAD0_opsz24.svg" alt="Logo Izquierda" class="logo__sena">
        </div>
        </header>
    <!-- Línea decorativa -->
    <div class="linea-verde"></div>

    <!-- Contenido principal -->

    <!-- Contenido principal debajo del header y encima del footer -->
    <main style="flex:1 0 auto;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;">
        <form class="container__forms" id="diagnosticoForm">
            <img src="../../../img/logo-proyecto1.png" alt="Logo SenaLink" class="logo__senalink"><br>

            <!-- Bloque de preguntas 1 -->

            <label>Pregunta 1:</label>
            <div class="pregunta-input-group">
                <input type="text" name="pregunta1" value="¿A qué sector productivo pertenece la empresa?" class="pregunta-enunciado" data-id="1" />
                <button type="button" class="btn-guardar-pregunta" title="Guardar enunciado">
                    <img src="../../../icon/check_purple.svg" alt="Guardar" />
                </button>
            </div>
            <div id="opciones1-edit" class="opciones-edit-group" data-pregunta-id="1">
                <div class="opcion-edit-row" data-opcion-id="1"><input type="text" value="Sector Primario (Agrícola)" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <div class="opcion-edit-row" data-opcion-id="2"><input type="text" value="Sector Secundario (Industrial)" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <div class="opcion-edit-row" data-opcion-id="3"><input type="text" value="Sector Terciario (Servicios)" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <div class="opcion-edit-row" data-opcion-id="4"><input type="text" value="Sector Cuaternario (Investigación y Desarrollo)" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <button type="button" class="btn btn-agregar" onclick="agregarOpcion('opciones1-edit')">Agregar opción</button>
            </div>


            <label>Pregunta 2:</label>
            <div class="pregunta-input-group">
                <input type="text" name="pregunta2" value="¿En qué áreas o procesos de su empresa considera que es necesario incorporar nuevo talento humano?" class="pregunta-enunciado" />
                <button type="button" class="btn-guardar-pregunta" title="Guardar enunciado">
                    <img src="../../../icon/check_purple.svg" alt="Guardar" />
                </button>
            </div>
            <div id="opciones2-edit" class="opciones-edit-group">
                <div class="opcion-edit-row"><input type="text" value="Áreas de talento humano" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <div class="opcion-edit-row"><input type="text" value="Administración de personal" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <div class="opcion-edit-row"><input type="text" value="Capacitación y selección de talento" class="opcion-edit" readonly/><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <div class="opcion-edit-row"><input type="text" value="Formación" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <div class="opcion-edit-row"><input type="text" value="Desarrollo organizacional" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <div class="opcion-edit-row"><input type="text" value="Salud y seguridad en el trabajo" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <button type="button" class="btn btn-agregar" onclick="agregarOpcion('opciones2-edit')">Agregar opción</button>
            </div>

            <label>Pregunta 3:</label>
            <div class="pregunta-input-group">
                <input type="text" name="pregunta3" value="¿Qué áreas de conocimiento o formativas considera importantes para fortalecer su empresa?" placeholder="Ingrese su respuesta" class="pregunta-enunciado">
                <button type="button" class="btn-guardar-pregunta" title="Guardar enunciado">
                    <img src="../../../icon/check_purple.svg" alt="Guardar" />
                </button>
            </div>

            <!-- Bloque de preguntas 2 -->
            <label>Pregunta 4:</label>
            <div class="pregunta-input-group">
                <input type="text" name="pregunta4" value="¿Qué tecnologías, herramientas o procesos específicos están presentes en su operación diaria?" placeholder="Ingrese su respuesta" class="pregunta-enunciado">
                <button type="button" class="btn-guardar-pregunta" title="Guardar enunciado">
                    <img src="../../../icon/check_purple.svg" alt="Guardar" />
                </button>
            </div>


            <label>Pregunta 5:</label>
            <div class="pregunta-input-group">
                <input type="text" name="pregunta5" value="¿Qué nivel de formación considera más adecuado para su empresa?" class="pregunta-enunciado" />
                <button type="button" class="btn-guardar-pregunta" title="Guardar enunciado">
                    <img src="../../../icon/check_purple.svg" alt="Guardar" />
                </button>
            </div>
            <div id="opciones5-edit" class="opciones-edit-group">
                <div class="opcion-edit-row"><input type="text" value="Auxiliar" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <div class="opcion-edit-row"><input type="text" value="Operario" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <div class="opcion-edit-row"><input type="text" value="Técnico" class="opcion-edit" readonly /><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <div class="opcion-edit-row"><input type="text" value="Tecnólogo" class="opcion-edit" readonly/><button type="button" class="btn-eliminar" onclick="eliminarOpcion(this)">🗑️</button></div>
                <button type="button" class="btn btn-agregar" onclick="agregarOpcion('opciones5-edit')">Agregar opción</button>
            </div>

            <label>Pregunta 6:</label>
            <div class="pregunta-input-group">
                <input type="text" name="pregunta6" value="¿Qué tipo de conocimientos o habilidades considera que hacen falta en su empresa?" placeholder="Ingrese su respuesta" class="pregunta-enunciado">
                <button type="button" class="btn-guardar-pregunta" title="Guardar enunciado">
                    <img src="../../../icon/check_purple.svg" alt="Guardar" />
                </button>
            </div>

            <!-- Botones -->
            <div class="form__buttons">
                <a href="../Home.html" class="btn">Resultado</a>
                <a href="../Diagnostico/VerDiagnostico.html" class="btn">Gestión</a>
                <a href="VerDiagnostico.html" class="btn">Guardar</a>
                <button type="button" onclick="goBack()" class="btn">Volver</button>
                
            </div>
            
        </form>
    </main>


    <script>
    // Mostrar botón guardar solo cuando se edite el input de pregunta
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('input[type="text"][name^="pregunta"]').forEach(function(input) {
            const btn = input.parentElement.querySelector('.btn-guardar-pregunta');
            if (!btn) return;
            input.addEventListener('input', function() {
                btn.style.display = 'inline-flex';
            });
            btn.addEventListener('click', function() {
                // Aquí puedes agregar la lógica para guardar el enunciado si lo deseas
                btn.style.display = 'none';
            });
        });
    });
    // Permite agregar inputs para nuevas opciones
function agregarOpcion(idGrupo) {
    const grupo = document.getElementById(idGrupo);
    const div = document.createElement('div');
    div.className = 'opcion-edit-row';
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'opcion-edit';
    input.placeholder = 'Nueva opción';
    // Botón guardar (check)
    const btnGuardar = document.createElement('button');
    btnGuardar.type = 'button';
    btnGuardar.className = 'btn-guardar';
    btnGuardar.title = 'Guardar opción';
    btnGuardar.innerHTML = '✔️';
    btnGuardar.onclick = function() {
        if(input.value.trim() === '') {
            input.focus();
            return;
        }
        // Al guardar, quitar el botón guardar y poner el de eliminar
        div.removeChild(btnGuardar);
        const btnEliminar = document.createElement('button');
        btnEliminar.type = 'button';
        btnEliminar.className = 'btn-eliminar';
        btnEliminar.innerText = '🗑️';
        btnEliminar.onclick = function() { eliminarOpcion(btnEliminar); };
        div.appendChild(btnEliminar);
        input.readOnly = false; // Permitir seguir editando
    };
    div.appendChild(input);
    div.appendChild(btnGuardar);
    // Busca el botón de "Agregar opción" dentro del grupo
    const btnAgregar = Array.from(grupo.querySelectorAll('button')).find(b => b.textContent.includes('Agregar opción'));
    if (btnAgregar) {
        grupo.insertBefore(div, btnAgregar);
    } else {
        grupo.appendChild(div);
    }
    input.focus();
}


    // Permite eliminar una opción
    function eliminarOpcion(btn) {
        const row = btn.parentElement;
        row.parentElement.removeChild(row);
    }
    //
    </script>
    <script src="../../../js/backbutton.js"></script>

    <script>
    // Enviar todos los cambios al backend al hacer click en el botón "Guardar" en form__buttons
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('diagnosticoForm');
        const btnGuardarGlobal = document.querySelector('.form__buttons a.btn[href="VerDiagnostico.html"]');

        btnGuardarGlobal.addEventListener('click', function(event) {
            event.preventDefault();

            // Recopilar enunciados de preguntas
            const preguntas = {};
            form.querySelectorAll('input.pregunta-enunciado').forEach(input => {
                const idPregunta = input.getAttribute('data-id');
                preguntas[idPregunta] = input.value.trim();
            });

            // Recopilar opciones nuevas (sin data-opcion-id)
            const nuevas_opciones = {};
            form.querySelectorAll('.opciones-edit-group').forEach(grupo => {
                const idPregunta = grupo.getAttribute('data-pregunta-id');
                const opcionesNuevas = [];
                grupo.querySelectorAll('.opcion-edit-row').forEach(row => {
                    if (!row.hasAttribute('data-opcion-id')) {
                        const texto = row.querySelector('input.opcion-edit').value.trim();
                        if (texto) opcionesNuevas.push(texto);
                    }
                });
                if (opcionesNuevas.length > 0) {
                    nuevas_opciones[idPregunta] = opcionesNuevas;
                }
            });

            // Recopilar opciones a borrar (con data-opcion-id pero que fueron eliminadas)
            // Para esto, se debe mantener una lista de opciones eliminadas en JS
            // Aquí asumimos que se mantiene en window.opcionesEliminadas
            const opciones_a_borrar = window.opcionesEliminadas || [];

            const payload = {
                preguntas: preguntas,
                nuevas_opciones: nuevas_opciones,
                opciones_a_borrar: opciones_a_borrar
            };

            fetch('../../../controllers/DiagnosticoController.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    accion: 'actualizarDiagnosticoCompleto',
                    ...payload
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Diagnóstico actualizado correctamente.');
                    window.location.href = '../Diagnostico/VerDiagnostico.html';
                } else {
                    alert('Error al actualizar diagnóstico: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error en la comunicación con el servidor.');
                console.error(error);
            });
        });

        // Inicializar array para opciones eliminadas
        window.opcionesEliminadas = [];

        // Modificar función eliminarOpcion para registrar opciones eliminadas
        window.eliminarOpcion = function(btn) {
            const row = btn.parentElement;
            const opcionId = row.getAttribute('data-opcion-id');
            if (opcionId) {
                window.opcionesEliminadas.push(opcionId);
            }
            row.parentElement.removeChild(row);
        };
    });
    </script>

    <!-- Pie de página -->
    <footer>
        <p>@ Todos los derechos reservados. SenaLink</p>
    </footer>

</body>
</html>
