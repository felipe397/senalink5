<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>SenaLink - Editar Empresa</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=menu"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=account_circle"
    />
    <link rel="stylesheet" href="../../../css/alert.css" />
    <link rel="stylesheet" href="../../../css/components/gov.css" />
    <link rel="stylesheet" href="../../../css/components/buttons.css" />
    <link rel="stylesheet" href="../../../css/layouts/Form_layout.css" />
    <link rel="stylesheet" href="../../../css/base.css" />
    <link rel="stylesheet" href="../../../css/readonly-fields.css" />
    <link rel="shortcut icon" href="../../../img/Favicon1.png" />
  </head>

  <body>
    <header class="gov" id="inicio">
      <div class="gov__container">
        <a href="https://www.gov.co/" target="_blank">
          <img
            loading="lazy"
            src="../../../img/gov-logo.svg"
            alt="Logo de la pagina gov.co"
            class="gov__img"
          />
        </a>
      </div>
    </header>

    <div class="container">
      <main
        class="container__crud"
        style="
          display: inline-block;
          min-width: 320px;
          max-width: 500px;
          width: fit-content;
          margin: 0 auto;
          padding: 2rem 2.5rem;
          box-sizing: border-box;
        "
      >
        <img
          alt="SenaLink Logo"
          src="../../../img/logo-proyecto1.png"
          class="logo__senalink"
        />

        <!-- FORMULARIO DE EDICIÓN EMPRESA -->
        <form
          action="../../../controllers/update_empresa.php"
          method="POST"
          id="empresaForm"
          class="form-layout validated-form"
        >
          <input type="hidden" name="id" id="empresa_id" value="" />

          <div class="form-group">
            <label for="nit">Número NIT</label>
            <input
              id="nit"
              class="input-field readonly-field"
              name="nit"
              type="text"
              placeholder="Número NIT"
              required
              readonly
            />
          </div>

          <div class="form-group">
            <label for="representante_legal">Representante legal</label>
            <input
              class="input-field"
              name="representante_legal"
              id="representante_legal"
              type="text"
              placeholder="Representante legal"
              required
            />
          </div>

          <div class="form-group">
            <label for="razon_social">Razón social</label>
            <input
              id="razon_social"
              class="input-field readonly-field"
              name="razon_social"
              type="text"
              placeholder="Razón social"
              required
              readonly
            />
          </div>

          <div class="form-group">
            <label for="telefono">Número telefónico</label>
            <input
              class="input-field"
              name="telefono"
              id="telefono"
              type="text"
              placeholder="Número telefónico"
              required
            />
          </div>

          <div class="form-group">
            <label for="correo">Correo electrónico</label>
            <input
              class="input-field"
              name="correo"
              id="correo"
              type="email"
              placeholder="Correo electrónico"
              required
            />
          </div>

          <div class="form-group">
            <label for="ubicacion">Ubicación</label>
            <input
              class="input-field"
              name="ubicacion"
              id="ubicacion"
              type="text"
              placeholder="Ubicación"
              required
            />
          </div>

          <!-- Nuevo campo Barrio -->
          <div class="form-group">
            <label for="barrio">Barrio</label>
            <input
              class="input-field"
              name="barrio"
              id="barrio"
              type="text"
              placeholder="Barrio"
              required
            />
          </div>

          <!-- Departamento -->
          <div class="form-group">
            <label for="departamento">Departamento</label>
            <select
              id="departamento"
              name="departamento"
              class="select_container"
              required
            >
              <option value="" disabled selected>
                Seleccione un departamento
              </option>
              <option value="Amazonas">Amazonas</option>
              <option value="Antioquia">Antioquia</option>
              <option value="Arauca">Arauca</option>
              <option value="Atlántico">Atlántico</option>
              <option value="Bogotá D.C.">Bogotá D.C.</option>
              <option value="Bolívar">Bolívar</option>
              <option value="Boyacá">Boyacá</option>
              <option value="Caldas">Caldas</option>
              <option value="Caquetá">Caquetá</option>
              <option value="Casanare">Casanare</option>
              <option value="Cauca">Cauca</option>
              <option value="Cesar">Cesar</option>
              <option value="Chocó">Chocó</option>
              <option value="Córdoba">Córdoba</option>
              <option value="Cundinamarca">Cundinamarca</option>
              <option value="Guainía">Guainía</option>
              <option value="Guaviare">Guaviare</option>
              <option value="Huila">Huila</option>
              <option value="La Guajira">La Guajira</option>
              <option value="Magdalena">Magdalena</option>
              <option value="Meta">Meta</option>
              <option value="Nariño">Nariño</option>
              <option value="Norte de Santander">Norte de Santander</option>
              <option value="Putumayo">Putumayo</option>
              <option value="Quindío">Quindío</option>
              <option value="Risaralda">Risaralda</option>
              <option value="San Andrés y Providencia">
                San Andrés y Providencia
              </option>
              <option value="Santander">Santander</option>
              <option value="Sucre">Sucre</option>
              <option value="Tolima">Tolima</option>
              <option value="Valle del Cauca">Valle del Cauca</option>
              <option value="Vaupés">Vaupés</option>
              <option value="Vichada">Vichada</option>
            </select>
          </div>

          <!-- Ciudad -->
          <div class="form-group">
            <label for="ciudad">Ciudad</label>
            <select id="ciudad" name="ciudad" class="select_container" required>
              <option value="" disabled selected>Seleccione una ciudad</option>
              <!-- Opciones se llenan dinámicamente -->
            </select>
          </div>

          <div class="form-group">
            <label for="sector_economico">Sector Económico</label>
            <input
              type="hidden"
              name="sector_economico"
              id="sector_economico"
              value=""
            />
            <select
              id="sector_economico_display"
              class="input-field readonly-field"
              disabled
              tabindex="-1"
            >
              <option value="Industria">Industria</option>
              <option value="Servicios">Servicios</option>
              <option value="Textiles">Textiles</option>
              <option value="Construccion">Construcción</option>
              <option value="Electricidad">Electricidad</option>
            </select>
          </div>

          <div class="btn__container">
            <button type="submit" class="btn">Guardar</button>
            <button type="button" onclick="goBack()" class="btn">Volver</button>
          </div>
        </form>
      </main>
    </div>

    <script src="../../../js/backbutton.js"></script>
    <script src="../../../js/alert.js"></script>
    <script>
      // Mapa departamentos y ciudades
      const departamentosCiudades = {
        Amazonas: ['Leticia', 'Puerto Nariño'],
        Antioquia: [
          'Medellín',
          'Bello',
          'Itagüí',
          'Envigado',
          'Rionegro',
          'Turbo',
          'Apartadó',
          'La Ceja',
          'Sabaneta',
          'Copacabana',
          'Girardota',
          'Marinilla',
        ],
        Arauca: ['Arauca', 'Arauquita', 'Saravena', 'Tame', 'Fortul'],
        Atlántico: [
          'Barranquilla',
          'Soledad',
          'Malambo',
          'Puerto Colombia',
          'Sabanalarga',
        ],
        'Bogotá D.C.': ['Bogotá'],
        Bolívar: [
          'Cartagena',
          'Magangué',
          'Turbaco',
          'Arjona',
          'San Juan Nepomuceno',
          'El Carmen de Bolívar',
        ],
        Boyacá: [
          'Tunja',
          'Duitama',
          'Sogamoso',
          'Chiquinquirá',
          'Paipa',
          'Puerto Boyacá',
        ],
        Caldas: ['Manizales', 'Villamaría', 'Chinchiná', 'La Dorada'],
        Caquetá: [
          'Florencia',
          'San Vicente del Caguán',
          'Puerto Rico',
          'El Doncello',
        ],
        Casanare: ['Yopal', 'Aguazul', 'Villanueva', 'Monterrey', 'Tauramena'],
        Cauca: [
          'Popayán',
          'Santander de Quilichao',
          'Puerto Tejada',
          'Patía',
          'Miranda',
        ],
        Cesar: [
          'Valledupar',
          'Aguachica',
          'Bosconia',
          'Curumaní',
          'La Jagua de Ibirico',
        ],
        Chocó: ['Quibdó', 'Istmina', 'Condoto', 'Bahía Solano', 'Acandí'],
        Córdoba: [
          'Montería',
          'Cereté',
          'Lorica',
          'Sahagún',
          'Tierralta',
          'Planeta Rica',
        ],
        Cundinamarca: [
          'Soacha',
          'Zipaquirá',
          'Girardot',
          'Facatativá',
          'Fusagasugá',
          'Chía',
          'Mosquera',
          'Cajicá',
          'Funza',
          'Madrid',
        ],
        Guainía: ['Inírida'],
        Guaviare: ['San José del Guaviare'],
        Huila: ['Neiva', 'Pitalito', 'Garzón', 'La Plata'],
        'La Guajira': [
          'Riohacha',
          'Maicao',
          'Uribia',
          'Fonseca',
          'San Juan del Cesar',
        ],
        Magdalena: [
          'Santa Marta',
          'Ciénaga',
          'Fundación',
          'Plato',
          'Aracataca',
        ],
        Meta: [
          'Villavicencio',
          'Acacías',
          'Granada',
          'Puerto López',
          'Cumaral',
        ],
        Nariño: ['Pasto', 'Ipiales', 'Tumaco', 'Túquerres'],
        'Norte de Santander': [
          'Cúcuta',
          'Ocaña',
          'Pamplona',
          'Villa del Rosario',
          'Los Patios',
        ],
        Putumayo: ['Mocoa', 'Puerto Asís', 'Orito', 'Villagarzón'],
        Quindío: ['Armenia', 'Calarcá', 'La Tebaida', 'Montenegro', 'Quimbaya'],
        Risaralda: [
          'Pereira',
          'Dosquebradas',
          'Santa Rosa de Cabal',
          'La Virginia',
        ],
        'San Andrés y Providencia': ['San Andrés', 'Providencia'],
        Santander: [
          'Bucaramanga',
          'Floridablanca',
          'Giron',
          'Piedecuesta',
          'Barrancabermeja',
          'Socorro',
          'San Gil',
        ],
        Sucre: ['Sincelejo', 'Corozal', 'Sampués', 'Tolú', 'San Marcos'],
        Tolima: ['Ibagué', 'Espinal', 'Melgar', 'Honda', 'Mariquita'],
        'Valle del Cauca': [
          'Cali',
          'Palmira',
          'Buenaventura',
          'Tuluá',
          'Buga',
          'Cartago',
          'Jamundí',
          'Yumbo',
        ],
        Vaupés: ['Mitú'],
        Vichada: ['Puerto Carreño'],
      };

      const departamentoSelect = document.getElementById('departamento');
      const ciudadSelect = document.getElementById('ciudad');

      function actualizarCiudades() {
        const depto = departamentoSelect.value;
        ciudadSelect.innerHTML =
          '<option value="" disabled selected>Seleccione una ciudad</option>';
        if (depto && departamentosCiudades[depto]) {
          departamentosCiudades[depto].forEach((ciudad) => {
            const option = document.createElement('option');
            option.value = ciudad;
            option.textContent = ciudad;
            ciudadSelect.appendChild(option);
          });
          ciudadSelect.disabled = false;
        } else {
          ciudadSelect.disabled = true;
        }
      }

      departamentoSelect.addEventListener('change', actualizarCiudades);

      // Guardar valores originales
      let originalValues = {};

      function getFormValues() {
        return {
          nit: document.getElementById('nit').value,
          representante_legal: document.getElementById('representante_legal')
            .value,
          razon_social: document.getElementById('razon_social').value,
          telefono: document.getElementById('telefono').value,
          correo: document.getElementById('correo').value,
          ubicacion: document.getElementById('ubicacion').value,
          barrio: document.getElementById('barrio').value,
          departamento: document.getElementById('departamento').value,
          ciudad: document.getElementById('ciudad').value,
          tipo_empresa: document.getElementById('sector_economico').value,
        };
      }

      function valuesChanged(current, original) {
        return Object.keys(original).some(
          (key) => current[key] != original[key]
        );
      }

      document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('empresaForm');
        form.addEventListener('submit', function (event) {
          const currentValues = getFormValues();
          if (!valuesChanged(currentValues, originalValues)) {
            event.preventDefault();
            showAlert(
              'No se realizaron cambios en los datos.',
              'warning',
              '.container'
            );
            return;
          }
          // Validación tipo societario en razón social
          const razonSocial = document
            .getElementById('razon_social')
            .value.trim();
          if (!/(S\.A\.?|S\.A\.S\.?|LTDA)/i.test(razonSocial)) {
            event.preventDefault();
            showAlert(
              'La razón social debe incluir el tipo societario: S.A, S.A.S o LTDA.',
              'error'
            );
            return;
          }
          event.preventDefault();
          const formData = new FormData(form);
          fetch(form.action, {
            method: 'POST',
            body: formData,
          })
            .then((response) => {
              const contentType = response.headers.get('content-type');
              if (
                contentType &&
                contentType.indexOf('application/json') !== -1
              ) {
                return response.json();
              } else {
                return response.text();
              }
            })
            .then((data) => {
              if (typeof data === 'object' && data !== null && data.success) {
                showAlert('Datos actualizados correctamente', 'success');
                setTimeout(() => {
                  window.location.href = 'Gestion_Empresa.html';
                }, 2000);
              } else if (
                typeof data === 'string' &&
                data.includes('actualizado')
              ) {
                showAlert('Datos actualizados correctamente', 'success');
                setTimeout(() => {
                  window.location.href = 'Gestion_Empresa.html';
                }, 2000);
              } else if (
                typeof data === 'object' &&
                data !== null &&
                data.errors
              ) {
                const mensajes = data.errors.join('<br>');
                showAlert(mensajes, 'error');
              } else if (
                typeof data === 'object' &&
                data !== null &&
                data.error
              ) {
                showAlert(data.error, 'error');
              } else {
                showAlert('Error al actualizar la empresa', 'error');
              }
            })
            .catch(() => {
              showAlert('Error en la comunicación con el servidor', 'error');
            });
        });

        const empresaId = new URLSearchParams(window.location.search).get('id');
        if (empresaId) {
          fetch(
            `../../../controllers/EmpresaController.php?action=detalleEmpresa&id=${empresaId}`
          )
            .then((response) => response.json())
            .then((data) => {
              console.log('Respuesta API detalleEmpresa:', data); // Debug log added
              if (!data.error) {
                document.getElementById('empresa_id').value = empresaId;
                document.getElementById('nit').value = data.nit || '';
                document.getElementById('representante_legal').value =
                  data.representante_legal || '';
                document.getElementById('razon_social').value =
                  data.razon_social || '';
                document.getElementById('telefono').value = data.telefono || '';
                document.getElementById('correo').value = data.correo || '';
                document.getElementById('ubicacion').value =
                  data.direccion || '';
                document.getElementById('barrio').value = data.barrio || '';
                // Asignar departamento y actualizar ciudades
                document.getElementById('departamento').value =
                  data.departamento || '';
                actualizarCiudades();
                // Asignar ciudad después de cargar opciones
                document.getElementById('ciudad').value = data.ciudad || '';

                // Sector económico: mostrar en select deshabilitado y guardar en hidden
                document.getElementById('sector_economico').value =
                  data.tipo_empresa || '';
                var select = document.getElementById(
                  'sector_economico_display'
                );
                var value = data.tipo_empresa || '';
                for (var i = 0; i < select.options.length; i++) {
                  if (select.options[i].value === value) {
                    select.selectedIndex = i;
                    break;
                  }
                }

                originalValues = getFormValues();
              } else {
                alert('Error al cargar los datos de la empresa.');
              }
            })
            .catch((error) => {
              console.error('Error al cargar los datos de la empresa:', error);
              alert('Error al cargar los datos de la empresa.');
            });
        } else {
          alert('No se recibió el ID de la empresa.');
        }
      });
    </script>
  </body>
</html>

<footer>
  <p>© Todos los derechos reservados. SenaLink</p>
</footer>
