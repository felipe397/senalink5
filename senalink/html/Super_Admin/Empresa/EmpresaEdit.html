<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>SenaLink - Editar Empresa</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=menu" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=account_circle" />
    <link rel="stylesheet" href="../../../css/alert.css" />
    <link rel="stylesheet" href="../../../css/components/gov.css" />
    <link rel="stylesheet" href="../../../css/components/buttons.css" />
    <link rel="stylesheet" href="../../../css/layouts/Form_layout.css" />
    <link rel="stylesheet" href="../../../css/base.css" />
    <link rel="shortcut icon" href="../../../img/Favicon1.png" />
</head>

<body>
    <header class="gov" id="inicio">
        <div class="gov__container">
            <a href="https://www.gov.co/" target="_blank">
                <img loading="lazy" src="../../../img/gov-logo.svg" alt="Logo de la pagina gov.co" class="gov__img" />
            </a>
        </div>
    </header>

    <div class="container">
    <main class="container__crud" style="display: inline-block; min-width: 320px; max-width: 500px; width: fit-content; margin: 0 auto; padding: 2rem 2.5rem; box-sizing: border-box;">
            <img alt="SenaLink Logo" src="../../../img/logo-proyecto1.png" class="logo__senalink" />

            <!-- FORMULARIO DE EDICIÓN EMPRESA -->
            <form action="../../../controllers/update_empresa.php" method="POST" id="empresaForm" class="form-layout validated-form">
                <input type="hidden" name="id" id="empresa_id" value="" />

                <div class="form-group">
                    <label for="nit">Número NIT</label>
                    <input class="input-field" name="nit" id="nit" type="text" placeholder="Número NIT" required readonly />
                </div>

                <div class="form-group">
                    <label for="representante_legal">Representante legal</label>
                    <input class="input-field" name="representante_legal" id="representante_legal" type="text" placeholder="Representante legal" required />
                </div>

                <div class="form-group">
                    <label for="razon_social">Razón social</label>
                    <input class="input-field" name="razon_social" id="razon_social" type="text" placeholder="Razón social" required readonly />
                </div>

                <div class="form-group">
                    <label for="telefono">Número telefónico</label>
                    <input class="input-field" name="telefono" id="telefono" type="text" placeholder="Número telefónico" required />
                </div>

                <div class="form-group">
                    <label for="correo">Correo electrónico</label>
                    <input class="input-field" name="correo" id="correo" type="email" placeholder="Correo electrónico" required />
                </div>

                <div class="form-group">
                    <label for="ubicacion">Ubicación</label>
                    <input class="input-field" name="ubicacion" id="ubicacion" type="text" placeholder="Ubicación" required />
                </div>

                <div class="form-group">
                    <label for="tipo_empresa">Sector Económico</label>
                    <select class="select_container" name="tipo_empresa" id="tipo_empresa" required>
                        <option value="" disabled selected>Selecciona un sector</option>
                        <option value="INDUSTRIAL">INDUSTRIAL</option>
                        <option value="SERVICIOS">SERVICIOS</option>
                    </select>
                </div>

                <div class="btn__container">
                    <button type="submit" class="btn">Guardar</button>
                    <button type="button" onclick="goBack()" class="btn">Volver</button>
                </div>
            </form>
        </main>
    </div>

    <script src="../../../js/backbutton.js"></script>
    <script src="../../../js/alert.js"></script>
    <script src="../../../js/control_inactividad.js"></script>
    <script>

        // Guardar valores originales
      let originalValues = {};

      function getFormValues() {
          return {
              nit: document.getElementById('nit').value,
              representante_legal: document.getElementById('representante_legal').value,
              razon_social: document.getElementById('razon_social').value,
              telefono: document.getElementById('telefono').value,
              correo: document.getElementById('correo').value,
              ubicacion: document.getElementById('ubicacion').value,
              tipo_empresa: document.getElementById('tipo_empresa').value,
          };
      }

      function valuesChanged(current, original) {
          return Object.keys(original).some(key => current[key] != original[key]);
      }



        document.addEventListener("DOMContentLoaded", function () {
        // Manejo de submit por fetch para mostrar alerta de éxito
        const form = document.getElementById('empresaForm');
        form.addEventListener('submit', function(event) {
            const currentValues = getFormValues();
            if (!valuesChanged(currentValues, originalValues)) {
                event.preventDefault();
                showAlert('No se realizaron cambios en los datos.', 'warning', '.container');
                return;
            }
            // Validación tipo societario en razón social
            const razonSocial = document.getElementById('razon_social').value.trim();
            if (!/(S\.A\.?|S\.A\.S\.?|LTDA)/i.test(razonSocial)) {
                event.preventDefault();
                showAlert('La razón social debe incluir el tipo societario: S.A, S.A.S o LTDA.', 'error');
                return;
            }
            event.preventDefault();
            const formData = new FormData(form);
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // Si la respuesta es JSON, procesar como tal
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.indexOf('application/json') !== -1) {
                    return response.json();
                } else {
                    return response.text();
                }
            })
                .then(data => {
                    if (typeof data === 'object' && data !== null && data.success) {
                        showAlert('Datos actualizados correctamente', 'success');
                        setTimeout(() => {
                            window.location.href = 'Gestion_Empresa.html';
                        }, 2000);
                    } else if (typeof data === 'string' && data.includes('actualizado')) {
                        showAlert('Datos actualizados correctamente', 'success');
                        setTimeout(() => {
                            window.location.href = 'Gestion_Empresa.html';
                        }, 2000);
                    } else if (typeof data === 'object' && data !== null && data.errors) {
                        // Mostrar todos los mensajes de error concatenados
                        const mensajes = data.errors.join('<br>');
                        showAlert(mensajes, 'error');
                    } else if (typeof data === 'object' && data !== null && data.error) {
                        showAlert(data.error, 'error');
                    } else {
                        showAlert('Error al actualizar la empresa', 'error');
                    }
                })
            .catch(() => {
                showAlert('Error en la comunicación con el servidor', 'error');
            });
        });
            const empresaId = new URLSearchParams(window.location.search).get('id');
            if (empresaId) {
                fetch(`../../../controllers/EmpresaController.php?action=detalleEmpresa&id=${empresaId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.error) {
                            document.getElementById('empresa_id').value = empresaId;
                            document.getElementById('nit').value = data.nit || '';
                            document.getElementById('representante_legal').value = data.representante_legal || '';
                            document.getElementById('razon_social').value = data.razon_social || '';
                            document.getElementById('telefono').value = data.telefono || '';
                            document.getElementById('correo').value = data.correo || '';
                            document.getElementById('ubicacion').value = data.direccion || '';
                            document.getElementById('tipo_empresa').value = data.tipo_empresa || '';
                            // Guardar valores originales después de cargar los datos
                            originalValues = getFormValues();
                        } else {
                            alert('Error al cargar los datos de la empresa.');
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar los datos de la empresa:', error);
                        alert('Error al cargar los datos de la empresa.');
                    });
            } else {
                alert('No se recibió el ID de la empresa.');
            }
        });
    </script>
</body>
</html>

<!-- FOOTER INICIO (copiado de Preguntas_frecuentes.html) -->
<footer>
    <p>© Todos los derechos reservados. SenaLink</p>
</footer>
